<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spider Ballooning Sonification — ASMR v3</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px;
      max-width: 920px;
      line-height: 1.4;
    }
    .card {
      border: 1px solid rgba(128,128,128,.35);
      border-radius: 16px;
      padding: 16px;
      margin: 14px 0;
    }
    .row {
      display: grid;
      grid-template-columns: 190px 1fr 90px;
      gap: 12px;
      align-items: center;
    }
    input[type="range"] { width: 100%; }
    button {
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 650;
    }
    .hint { opacity: .75; font-size: 0.95rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <h1>Spider Ballooning Sonification — ASMR v3</h1>
  <p class="hint">
    Slightly higher-pitched, softer, less “digital” textures with wide stereo drift.
    (Headphones recommended.)
  </p>

  <div class="card">
    <button id="toggle">Start Audio</button>
    <span id="status" class="mono" style="margin-left:10px; opacity:.85;">stopped</span>
  </div>

  <div class="card">
    <div class="row">
      <label><b>Rate</b> (events/sec)</label>
      <input id="rate" type="range" min="0.2" max="6" step="0.1" value="1.0" />
      <div id="rateVal" class="mono">1.0</div>
    </div>

    <div class="row" style="margin-top:12px;">
      <label><b>Loudness</b></label>
      <input id="loud" type="range" min="0" max="1" step="0.01" value="0.28" />
      <div id="loudVal" class="mono">0.28</div>
    </div>

    <div class="row" style="margin-top:12px;">
      <label><b>Reverb</b> (wet/dry)</label>
      <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.48" />
      <div id="reverbVal" class="mono">0.48</div>
    </div>
  </div>

<script>
(() => {
  let ctx = null;
  let master, comp;
  let dryGain, wetGain, reverbIn, convolver;
  let wind = null;
  let running = false;
  let gustTimer = null;
  let spiderTimer = null;

  const toggleBtn = document.getElementById("toggle");
  const statusEl = document.getElementById("status");
  const rateEl = document.getElementById("rate");
  const loudEl = document.getElementById("loud");
  const reverbEl = document.getElementById("reverb");
  const rateVal = document.getElementById("rateVal");
  const loudVal = document.getElementById("loudVal");
  const reverbVal = document.getElementById("reverbVal");

  const rand = (a,b)=>a+Math.random()*(b-a);

  rateEl.oninput = ()=> rateVal.textContent = Number(rateEl.value).toFixed(1);
  loudEl.oninput = ()=>{
    loudVal.textContent = Number(loudEl.value).toFixed(2);
    if(master && ctx){
      const t=ctx.currentTime;
      master.gain.setTargetAtTime(Number(loudEl.value),t,0.04);
    }
  };
  reverbEl.oninput = ()=>{
    const v=Number(reverbEl.value);
    reverbVal.textContent=v.toFixed(2);
    if(dryGain && wetGain && ctx){
      const t=ctx.currentTime;
      wetGain.gain.setTargetAtTime(v,t,0.06);
      dryGain.gain.setTargetAtTime(1-v,t,0.06);
    }
  };

  function makeImpulse(){
    const len = ctx.sampleRate*4.5;
    const buf = ctx.createBuffer(2,len,ctx.sampleRate);
    for(let c=0;c<2;c++){
      const d=buf.getChannelData(c);
      for(let i=0;i<len;i++){
        d[i]=(Math.random()*2-1)*Math.pow(1-i/len,4.2);
      }
    }
    return buf;
  }

  function slowPan(panner,speed,depth,base=0){
    panner.pan.value=base;
    const lfo=ctx.createOscillator();
    const g=ctx.createGain();
    lfo.frequency.value=speed;
    g.gain.value=depth;
    lfo.connect(g).connect(panner.pan);
    lfo.start();
    return lfo;
  }

  function connectWetDry(node){
    node.connect(dryGain);
    node.connect(reverbIn);
  }

  function ensureAudio(){
    if(ctx) return;
    ctx=new (window.AudioContext||window.webkitAudioContext)();

    master=ctx.createGain();
    master.gain.value=Number(loudEl.value);

    comp=ctx.createDynamicsCompressor();
    comp.threshold.value=-24;
    comp.knee.value=18;
    comp.ratio.value=2.0;
    comp.attack.value=0.015;
    comp.release.value=0.35;

    dryGain=ctx.createGain();
    wetGain=ctx.createGain();
    reverbIn=ctx.createGain();
    convolver=ctx.createConvolver();

    const w=Number(reverbEl.value);
    wetGain.gain.value=w;
    dryGain.gain.value=1-w;
    reverbIn.gain.value=0.68;

    convolver.buffer=makeImpulse();

    dryGain.connect(master);
    wetGain.connect(master);
    master.connect(comp);
    comp.connect(ctx.destination);
    reverbIn.connect(convolver);
    convolver.connect(wetGain);

    // Wind bed: smoother + higher spectral center
    const noiseBuf=ctx.createBuffer(1,ctx.sampleRate*3,ctx.sampleRate);
    const nd=noiseBuf.getChannelData(0);
    for(let i=0;i<nd.length;i++) nd[i]=Math.random()*2-1;
    const noise=ctx.createBufferSource();
    noise.buffer=noiseBuf;
    noise.loop=true;

    const hp=ctx.createBiquadFilter();
    hp.type="highpass"; hp.frequency.value=180;

    const bp=ctx.createBiquadFilter();
    bp.type="bandpass"; bp.frequency.value=760; bp.Q.value=0.45;

    const lp=ctx.createBiquadFilter();
    lp.type="lowpass"; lp.frequency.value=3200;

    const baseGain=ctx.createGain();
    baseGain.gain.value=0.012;

    const panner=ctx.createStereoPanner();
    slowPan(panner,0.006,0.95);

    noise.connect(hp);
    hp.connect(bp);
    bp.connect(lp);
    lp.connect(baseGain);
    baseGain.connect(panner);
    connectWetDry(panner);
    noise.start();

    wind={noise};
  }

  function spawnSpider(){
    if(!ctx) return;
    const now=ctx.currentTime;
    const r=Number(rateEl.value);

    const p=ctx.createStereoPanner();
    slowPan(p,rand(0.05,0.15),0.95,rand(-0.3,0.3));

    const o1=ctx.createOscillator();
    const o2=ctx.createOscillator();
    o1.type="sine";
    o2.type="triangle";

    const f0=rand(260,520);     // higher pitch
    const f1=f0*rand(2.2,3.6);

    o1.frequency.setValueAtTime(f0,now);
    o2.frequency.setValueAtTime(f0*1.9,now);
    o1.frequency.exponentialRampToValueAtTime(f1,now+0.28);
    o2.frequency.exponentialRampToValueAtTime(f1*1.6,now+0.28);

    const bp=ctx.createBiquadFilter();
    bp.type="bandpass"; bp.Q.value=8;
    bp.frequency.value=f0*2.4;

    const g=ctx.createGain();
    g.gain.setValueAtTime(0.0001,now);
    g.gain.linearRampToValueAtTime(0.035,now+0.1);
    g.gain.exponentialRampToValueAtTime(0.0001,now+0.45);

    o1.connect(g);
    o2.connect(g);
    g.connect(bp);
    bp.connect(p);
    connectWetDry(p);

    o1.start(now);
    o2.start(now);
    o1.stop(now+0.5);
    o2.stop(now+0.5);
  }

  function scheduleSpiders(){
    spawnSpider();
    const r=Number(rateEl.value);
    const next=-Math.log(1-Math.random())*(1/Math.max(0.05,r));
    spiderTimer=setTimeout(scheduleSpiders,next*1000);
  }

  async function start(){
    ensureAudio();
    await ctx.resume();
    running=true;
    toggleBtn.textContent="Stop Audio";
    statusEl.textContent="running";
    scheduleSpiders();
  }

  async function stop(){
    running=false;
    toggleBtn.textContent="Start Audio";
    statusEl.textContent="stopped";
    if(spiderTimer) clearTimeout(spiderTimer);
    if(ctx){
      master.gain.setTargetAtTime(0.0001,ctx.currentTime,0.05);
      await ctx.close();
    }
    ctx=null;
  }

  toggleBtn.onclick=()=>running?stop():start();
})();
</script>
</body>
</html>
