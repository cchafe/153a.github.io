<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life in the Boundary Layer - Sonification</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2d5016, #4a7c59, #8fbc8f);
            font-family: 'Georgia', serif;
            color: #2d4a2d;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #2d5016;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            text-align: center;
            font-style: italic;
            color: #4a7c59;
            margin-bottom: 30px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f0f8f0;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #8fbc8f;
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #2d5016;
            font-size: 1.1em;
        }
        
        button {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #2d5016;
        }
        
        button:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }
        
        label {
            display: block;
            margin: 5px 0;
            font-weight: bold;
            color: #2d5016;
        }
        
        .description {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4a7c59;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .layer-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .layer-viz {
            width: 60%;
            height: 20px;
            background: linear-gradient(to right, #8fbc8f, #4a7c59, #2d5016);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .moss-indicator {
            position: absolute;
            left: 2px;
            top: 2px;
            bottom: 2px;
            width: 20px;
            background: #228b22;
            border-radius: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Life in the Boundary Layer</h1>
        <p class="subtitle">An audio sonification inspired by Robin Wall Kimmerer's "Gathering Moss"</p>
        
        <div class="controls">
            <div class="control-group">
                <h3>üå± Moss Ecosystem</h3>
                <button id="startBtn">Start Boundary Layer</button>
                <button id="stopBtn" disabled>Stop</button>
                <label>Moss Density: <span id="densityValue">50</span>%</label>
                <input type="range" id="density" min="10" max="100" value="50">
            </div>
            
            <div class="control-group">
                <h3>üå¨Ô∏è Air Flow</h3>
                <label>Wind Speed: <span id="windValue">30</span>%</label>
                <input type="range" id="windSpeed" min="0" max="100" value="30">
                <label>Turbulence: <span id="turbulenceValue">40</span>%</label>
                <input type="range" id="turbulence" min="0" max="100" value="40">
            </div>
            
            <div class="control-group">
                <h3>üå°Ô∏è Environment</h3>
                <label>Humidity: <span id="humidityValue">70</span>%</label>
                <input type="range" id="humidity" min="0" max="100" value="70">
                <label>Temperature: <span id="tempValue">60</span>¬∞F</label>
                <input type="range" id="temperature" min="32" max="100" value="60">
            </div>
            
            <div class="control-group">
                <h3>üéµ Audio</h3>
                <label>Master Volume: <span id="volumeValue">70</span>%</label>
                <input type="range" id="volume" min="0" max="100" value="70">
                <button id="dewBtn">Morning Dew</button>
                <button id="sporeBtn">Spore Release</button>
            </div>
        </div>
        
        <div class="layer-indicator">
            <span>Boundary Layer Visualization:</span>
            <div class="layer-viz">
                <div class="moss-indicator"></div>
            </div>
            <span>Free Air</span>
        </div>
        
        <div class="description">
            <p><strong>About this sonification:</strong></p>
            <p>This audio experience translates the microscopic world of mosses living in the boundary layer into sound. The FM synthesis creates organic, breathing textures that represent the moss community, while stereo effects simulate the spatial environment described in Kimmerer's text.</p>
            <ul>
                <li><strong>Low frequencies:</strong> The still air and substrate of the boundary layer</li>
                <li><strong>Mid frequencies:</strong> The moss community itself - growing, breathing, photosynthesizing</li>
                <li><strong>High frequencies:</strong> Turbulent air above, spore dispersal, and environmental interactions</li>
                <li><strong>Stereo panning:</strong> Simulates air movement and spatial distribution</li>
                <li><strong>Reverb:</strong> Creates the acoustic space of different boundary layer depths</li>
            </ul>
        </div>
    </div>

    <script>
        class BoundaryLayerSonification {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.oscillators = [];
                this.gainNodes = [];
                this.panNodes = [];
                this.reverbNode = null;
                this.masterGain = null;
                
                this.setupEventListeners();
            }
            
            async initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master gain
                this.masterGain = this.audioContext.createGain();
                this.masterGain.connect(this.audioContext.destination);
                
                // Create reverb
                this.reverbNode = await this.createReverb();
                this.reverbNode.connect(this.masterGain);
                
                // Create dry signal path
                this.dryGain = this.audioContext.createGain();
                this.dryGain.connect(this.masterGain);
            }
            
            async createReverb() {
                const convolver = this.audioContext.createConvolver();
                const impulseResponse = this.createImpulseResponse(2, 2, false);
                convolver.buffer = impulseResponse;
                return convolver;
            }
            
            createImpulseResponse(duration, decay, reverse) {
                const sampleRate = this.audioContext.sampleRate;
                const length = sampleRate * duration;
                const impulse = this.audioContext.createBuffer(2, length, sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const channelData = impulse.getChannelData(channel);
                    for (let i = 0; i < length; i++) {
                        const n = reverse ? length - i : i;
                        channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                    }
                }
                return impulse;
            }
            
            createMossVoice(frequency, pan = 0) {
                // FM synthesis for organic moss-like sounds
                const carrier = this.audioContext.createOscillator();
                const modulator = this.audioContext.createOscillator();
                const modulatorGain = this.audioContext.createGain();
                const carrierGain = this.audioContext.createGain();
                const panNode = this.audioContext.createStereoPanner();
                
                // Set up FM synthesis
                carrier.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                modulator.frequency.setValueAtTime(frequency * 0.5, this.audioContext.currentTime);
                modulatorGain.gain.setValueAtTime(frequency * 0.3, this.audioContext.currentTime);
                
                // Use sine waves for organic sound
                carrier.type = 'sine';
                modulator.type = 'sine';
                
                // Connect FM synthesis
                modulator.connect(modulatorGain);
                modulatorGain.connect(carrier.frequency);
                carrier.connect(carrierGain);
                
                // Set up panning
                panNode.pan.setValueAtTime(pan, this.audioContext.currentTime);
                carrierGain.connect(panNode);
                
                // Connect to both dry and wet (reverb) paths
                const wetGain = this.audioContext.createGain();
                const dryGain = this.audioContext.createGain();
                
                panNode.connect(wetGain);
                panNode.connect(dryGain);
                wetGain.connect(this.reverbNode);
                dryGain.connect(this.dryGain);
                
                return {
                    carrier,
                    modulator,
                    carrierGain,
                    modulatorGain,
                    panNode,
                    wetGain,
                    dryGain
                };
            }
            
            start() {
                if (this.isPlaying) return;
                
                this.initAudio().then(() => {
                    this.isPlaying = true;
                    this.createMossEcosystem();
                    this.startEnvironmentalChanges();
                    
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                });
            }
            
            stop() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                
                // Stop all oscillators
                this.oscillators.forEach(osc => {
                    try {
                        osc.stop();
                    } catch (e) {
                        // Oscillator might already be stopped
                    }
                });
                
                this.oscillators = [];
                this.gainNodes = [];
                this.panNodes = [];
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
            
            createMossEcosystem() {
                const density = parseInt(document.getElementById('density').value);
                const numVoices = Math.floor(density / 10) + 3;
                
                // Base frequencies for different moss "species"
                const baseFreqs = [55, 82.4, 110, 146.8, 220];
                
                for (let i = 0; i < numVoices; i++) {
                    const freq = baseFreqs[i % baseFreqs.length] * (1 + Math.random() * 0.1);
                    const pan = (Math.random() - 0.5) * 1.5; // -0.75 to 0.75
                    
                    const voice = this.createMossVoice(freq, pan);
                    
                    // Start oscillators
                    voice.carrier.start();
                    voice.modulator.start();
                    
                    // Set initial volumes
                    voice.carrierGain.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    voice.wetGain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    voice.dryGain.gain.setValueAtTime(0.7, this.audioContext.currentTime);
                    
                    this.oscillators.push(voice.carrier, voice.modulator);
                    this.gainNodes.push(voice.carrierGain, voice.wetGain, voice.dryGain);
                    this.panNodes.push(voice.panNode);
                    
                    // Add subtle breathing effect
                    this.addBreathingEffect(voice, i);
                }
                
                this.updateMasterVolume();
            }
            
            addBreathingEffect(voice, index) {
                const breathingRate = 0.1 + Math.random() * 0.05; // 0.1-0.15 Hz
                const breathingDepth = 0.02 + Math.random() * 0.03; // 0.02-0.05
                
                const breathe = () => {
                    if (!this.isPlaying) return;
                    
                    const time = this.audioContext.currentTime;
                    const currentGain = voice.carrierGain.gain.value;
                    const targetGain = 0.1 + Math.sin(time * breathingRate * 2 * Math.PI + index) * breathingDepth;
                    
                    voice.carrierGain.gain.linearRampToValueAtTime(targetGain, time + 0.1);
                    
                    setTimeout(breathe, 100);
                };
                
                setTimeout(breathe, index * 200); // Stagger the breathing
            }
            
            startEnvironmentalChanges() {
                const updateEnvironment = () => {
                    if (!this.isPlaying) return;
                    
                    const windSpeed = parseInt(document.getElementById('windSpeed').value);
                    const turbulence = parseInt(document.getElementById('turbulence').value);
                    const humidity = parseInt(document.getElementById('humidity').value);
                    
                    // Update panning based on wind
                    this.panNodes.forEach((panNode, index) => {
                        const windEffect = (windSpeed / 100) * 0.3 * Math.sin(this.audioContext.currentTime * 0.5 + index);
                        const currentPan = panNode.pan.value;
                        const newPan = Math.max(-1, Math.min(1, currentPan + windEffect));
                        panNode.pan.linearRampToValueAtTime(newPan, this.audioContext.currentTime + 0.5);
                    });
                    
                    // Update reverb mix based on humidity
                    const wetAmount = humidity / 100 * 0.5;
                    const dryAmount = 1 - wetAmount;
                    
                    this.gainNodes.forEach((gainNode, index) => {
                        if (index % 3 === 1) { // wet gain nodes
                            gainNode.gain.linearRampToValueAtTime(wetAmount, this.audioContext.currentTime + 0.5);
                        } else if (index % 3 === 2) { // dry gain nodes
                            gainNode.gain.linearRampToValueAtTime(dryAmount, this.audioContext.currentTime + 0.5);
                        }
                    });
                    
                    setTimeout(updateEnvironment, 500);
                };
                
                updateEnvironment();
            }
            
            triggerDew() {
                if (!this.isPlaying) return;
                
                // Create gentle high-frequency sparkles for dew formation
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const dewOsc = this.audioContext.createOscillator();
                        const dewGain = this.audioContext.createGain();
                        const dewPan = this.audioContext.createStereoPanner();
                        
                        dewOsc.frequency.setValueAtTime(800 + Math.random() * 1200, this.audioContext.currentTime);
                        dewOsc.type = 'sine';
                        
                        dewPan.pan.setValueAtTime((Math.random() - 0.5) * 2, this.audioContext.currentTime);
                        
                        dewOsc.connect(dewGain);
                        dewGain.connect(dewPan);
                        dewPan.connect(this.reverbNode);
                        
                        const now = this.audioContext.currentTime;
                        dewGain.gain.setValueAtTime(0, now);
                        dewGain.gain.linearRampToValueAtTime(0.05, now + 0.1);
                        dewGain.gain.exponentialRampToValueAtTime(0.001, now + 2);
                        
                        dewOsc.start(now);
                        dewOsc.stop(now + 2);
                    }, i * 200);
                }
            }
            
            triggerSporeRelease() {
                if (!this.isPlaying) return;
                
                // Create ascending particles for spore dispersal
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const sporeOsc = this.audioContext.createOscillator();
                        const sporeGain = this.audioContext.createGain();
                        const sporePan = this.audioContext.createStereoPanner();
                        
                        const startFreq = 200 + Math.random() * 300;
                        const endFreq = startFreq * (2 + Math.random());
                        
                        sporeOsc.frequency.setValueAtTime(startFreq, this.audioContext.currentTime);
                        sporeOsc.frequency.exponentialRampToValueAtTime(endFreq, this.audioContext.currentTime + 1.5);
                        sporeOsc.type = 'triangle';
                        
                        sporePan.pan.setValueAtTime((Math.random() - 0.5) * 2, this.audioContext.currentTime);
                        
                        sporeOsc.connect(sporeGain);
                        sporeGain.connect(sporePan);
                        sporePan.connect(this.dryGain);
                        
                        const now = this.audioContext.currentTime;
                        sporeGain.gain.setValueAtTime(0, now);
                        sporeGain.gain.linearRampToValueAtTime(0.03, now + 0.1);
                        sporeGain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                        
                        sporeOsc.start(now);
                        sporeOsc.stop(now + 1.5);
                    }, i * 100);
                }
            }
            
            updateMasterVolume() {
                if (this.masterGain) {
                    const volume = parseInt(document.getElementById('volume').value) / 100;
                    this.masterGain.gain.linearRampToValueAtTime(volume * 0.3, this.audioContext.currentTime + 0.1);
                }
            }
            
            setupEventListeners() {
                document.getElementById('startBtn').addEventListener('click', () => this.start());
                document.getElementById('stopBtn').addEventListener('click', () => this.stop());
                document.getElementById('dewBtn').addEventListener('click', () => this.triggerDew());
                document.getElementById('sporeBtn').addEventListener('click', () => this.triggerSporeRelease());
                
                // Volume control
                document.getElementById('volume').addEventListener('input', (e) => {
                    document.getElementById('volumeValue').textContent = e.target.value;
                    this.updateMasterVolume();
                });
                
                // Update display values
                ['density', 'windSpeed', 'turbulence', 'humidity', 'temperature'].forEach(id => {
                    const element = document.getElementById(id);
                    element.addEventListener('input', (e) => {
                        const valueElement = document.getElementById(id + 'Value');
                        valueElement.textContent = e.target.value + (id === 'temperature' ? '¬∞F' : '%');
                    });
                });
            }
        }
        
        // Initialize the sonification
        const sonification = new BoundaryLayerSonification();
    </script>
</body>
</html>
