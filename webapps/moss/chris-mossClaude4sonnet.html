<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life in the Boundary Layer - Sonification</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #2d5016, #4a7c59);
            color: #e8f5e8;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #a8d8a8;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .subtitle {
            color: #c8e8c8;
            font-style: italic;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(168, 216, 168, 0.3);
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #a8d8a8;
            font-size: 1em;
        }
        
        button {
            background: linear-gradient(135deg, #4a7c59, #6b9b6b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: linear-gradient(135deg, #5a8c69, #7bab7b);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.active {
            background: linear-gradient(135deg, #6b9b6b, #8bbb8b);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            accent-color: #6b9b6b;
        }
        
        .description {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
            line-height: 1.6;
            border-left: 4px solid #6b9b6b;
        }
        
        .visualization {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(168, 216, 168, 0.3);
        }
        
        canvas {
            width: 100%;
            height: 100%;
        }
        
        .layer-indicator {
            position: absolute;
            right: 10px;
            top: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #a8d8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Life in the Boundary Layer</h1>
        <p class="subtitle">A sonic exploration of moss ecology through FM synthesis</p>
        
        <div class="description">
            <p><strong>About this sonification:</strong> This piece translates Robin Wall Kimmerer's description of moss life into sound. The boundary layer - that thin zone of still air where mosses thrive - is represented through layered FM synthesis. Each moss voice uses frequency modulation to create organic, breathing tones that respond to their microenvironment.</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>Ecosystem Control</h3>
                <button id="playBtn">Start Ecosystem</button>
                <button id="stopBtn">Stop</button>
            </div>
            
            <div class="control-group">
                <h3>Master Volume</h3>
                <input type="range" id="volume" min="0" max="1" step="0.05" value="0.3">
                <div>Silent ← → Loud</div>
            </div>
            
            <div class="control-group">
                <h3>Boundary Layer Depth</h3>
                <input type="range" id="boundaryDepth" min="0.1" max="2.0" step="0.1" value="1.0">
                <div>Shallow ← → Deep Forest</div>
            </div>
            
            <div class="control-group">
                <h3>Moisture Level</h3>
                <input type="range" id="moisture" min="0" max="1" step="0.05" value="0.6">
                <div>Arid ← → Humid</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>Wind Turbulence</h3>
                <input type="range" id="turbulence" min="0" max="1" step="0.05" value="0.3">
                <div>Still ← → Windy</div>
            </div>
            
            <div class="control-group">
                <h3>Moss Communities</h3>
                <button id="rockMoss" class="moss-btn">Rock Face Moss</button>
                <button id="logMoss" class="moss-btn">Decaying Log Moss</button>
                <button id="forestMoss" class="moss-btn">Forest Floor Moss</button>
            </div>
            
            <div class="control-group">
                <h3>Spore Dispersal</h3>
                <button id="sporeRelease">Release Spores</button>
                <div style="font-size: 12px; margin-top: 5px;">Escape the boundary layer</div>
            </div>
        </div>
        
        <div class="visualization">
            <canvas id="visualizer"></canvas>
            <div class="layer-indicator" id="layerInfo">Boundary Layer: 1.0x</div>
        </div>
        
        <div class="description">
            <p><strong>Sound Design:</strong> Each moss type has its own FM synthesis voice with unique characteristics. Rock mosses are bright and crystalline, log mosses are warm and rich with enhanced CO₂ harmonics, and forest mosses are lush and complex. The boundary layer depth affects reverb and filtering, while moisture and wind influence the synthesis parameters and spatial positioning.</p>
        </div>
    </div>

    <script>
        class BoundaryLayerSonification {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.masterGain = null;
                this.reverbSend = null;
                this.reverbReturn = null;
                this.convolver = null;
                
                // Moss voices
                this.mossVoices = {
                    rock: null,
                    log: null,
                    forest: null
                };
                
                // Environmental parameters
                this.boundaryDepth = 1.0;
                this.moisture = 0.6;
                this.turbulence = 0.3;
                this.volume = 0.3;
                
                // Visualization
                this.canvas = document.getElementById('visualizer');
                this.ctx = this.canvas.getContext('2d');
                this.animationId = null;
                
                this.setupEventListeners();
                this.setupVisualization();
            }
            
            async initAudio() {
                if (this.audioContext) return;
                
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Master gain
                this.masterGain = this.audioContext.createGain();
                this.masterGain.gain.value = this.volume;
                this.masterGain.connect(this.audioContext.destination);
                
                // Create reverb
                await this.createReverb();
                
                // Create moss voices
                this.createMossVoices();
            }
            
            async createReverb() {
                this.convolver = this.audioContext.createConvolver();
                this.reverbSend = this.audioContext.createGain();
                this.reverbReturn = this.audioContext.createGain();
                
                // Create impulse response for boundary layer reverb
                const length = this.audioContext.sampleRate * 2;
                const impulse = this.audioContext.createBuffer(2, length, this.audioContext.sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const channelData = impulse.getChannelData(channel);
                    for (let i = 0; i < length; i++) {
                        const decay = Math.pow(1 - i / length, 2);
                        channelData[i] = (Math.random() * 2 - 1) * decay * 0.1;
                    }
                }
                
                this.convolver.buffer = impulse;
                this.reverbSend.connect(this.convolver);
                this.convolver.connect(this.reverbReturn);
                this.reverbReturn.connect(this.masterGain);
                this.reverbReturn.gain.value = 0.3;
            }
            
            createMossVoices() {
                // Rock moss - bright, crystalline, thin boundary layer
                this.mossVoices.rock = this.createFMVoice({
                    carrierFreq: 220,
                    modFreq: 330,
                    modIndex: 2,
                    pan: -0.3,
                    filterFreq: 2000,
                    active: false
                });
                
                // Log moss - warm, rich, CO2 enhanced
                this.mossVoices.log = this.createFMVoice({
                    carrierFreq: 165,
                    modFreq: 55,
                    modIndex: 4,
                    pan: 0.3,
                    filterFreq: 800,
                    active: false
                });
                
                // Forest moss - lush, complex, deep boundary layer
                this.mossVoices.forest = this.createFMVoice({
                    carrierFreq: 110,
                    modFreq: 165,
                    modIndex: 6,
                    pan: 0,
                    filterFreq: 1200,
                    active: false
                });
            }
            
            createFMVoice(params) {
                const voice = {
                    carrier: this.audioContext.createOscillator(),
                    modulator: this.audioContext.createOscillator(),
                    modGain: this.audioContext.createGain(),
                    envelope: this.audioContext.createGain(),
                    filter: this.audioContext.createBiquadFilter(),
                    panner: this.audioContext.createStereoPanner(),
                    lfo: this.audioContext.createOscillator(),
                    lfoGain: this.audioContext.createGain(),
                    active: params.active,
                    baseCarrierFreq: params.carrierFreq,
                    baseModFreq: params.modFreq,
                    baseModIndex: params.modIndex
                };
                
                // Setup FM synthesis
                voice.carrier.frequency.value = params.carrierFreq;
                voice.modulator.frequency.value = params.modFreq;
                voice.modGain.gain.value = params.modIndex * params.modFreq;
                
                // Setup filter
                voice.filter.type = 'lowpass';
                voice.filter.frequency.value = params.filterFreq;
                voice.filter.Q.value = 2;
                
                // Setup panning
                voice.panner.pan.value = params.pan;
                
                // Setup LFO for organic movement
                voice.lfo.frequency.value = 0.1 + Math.random() * 0.2;
                voice.lfoGain.gain.value = 10;
                
                // Connect the graph
                voice.modulator.connect(voice.modGain);
                voice.modGain.connect(voice.carrier.frequency);
                voice.carrier.connect(voice.envelope);
                voice.envelope.connect(voice.filter);
                voice.filter.connect(voice.panner);
                voice.panner.connect(this.masterGain);
                voice.panner.connect(this.reverbSend);
                
                // Connect LFO to carrier frequency for organic variation
                voice.lfo.connect(voice.lfoGain);
                voice.lfoGain.connect(voice.carrier.frequency);
                
                // Start oscillators
                voice.carrier.start();
                voice.modulator.start();
                voice.lfo.start();
                
                // Initial envelope
                voice.envelope.gain.value = 0;
                
                return voice;
            }
            
            updateVolume() {
                if (this.masterGain) {
                    this.masterGain.gain.value = this.volume;
                }
            }
            
            updateEnvironment() {
                Object.values(this.mossVoices).forEach(voice => {
                    if (!voice || !voice.active) return;
                    
                    // Boundary layer affects filter frequency and reverb
                    const boundaryEffect = this.boundaryDepth;
                    voice.filter.frequency.value = voice.filter.frequency.value * (0.5 + boundaryEffect);
                    
                    // Moisture affects modulation index
                    const moistureEffect = 0.5 + this.moisture * 0.5;
                    voice.modGain.gain.value = voice.baseModIndex * voice.baseModFreq * moistureEffect;
                    
                    // Turbulence affects LFO and panning
                    voice.lfo.frequency.value = 0.1 + this.turbulence * 0.5;
                    voice.lfoGain.gain.value = 5 + this.turbulence * 20;
                });
                
                // Update reverb based on boundary layer
                if (this.reverbReturn) {
                    this.reverbReturn.gain.value = 0.1 + this.boundaryDepth * 0.4;
                }
            }
            
            toggleMoss(type) {
                const voice = this.mossVoices[type];
                if (!voice) return;
                
                const button = document.getElementById(type + 'Moss');
                
                if (voice.active) {
                    // Fade out
                    voice.envelope.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.5);
                    voice.active = false;
                    button.classList.remove('active');
                } else {
                    // Fade in
                    voice.envelope.gain.setValueAtTime(0.001, this.audioContext.currentTime);
                    voice.envelope.gain.exponentialRampToValueAtTime(0.1, this.audioContext.currentTime + 0.5);
                    voice.active = true;
                    button.classList.add('active');
                }
            }
            
            releaseSpores() {
                // Create ascending spore sounds that escape the boundary layer
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        this.createSporeSound(i);
                    }, i * 200);
                }
            }
            
            createSporeSound(index) {
                const spore = this.audioContext.createOscillator();
                const sporeGain = this.audioContext.createGain();
                const sporePanner = this.audioContext.createStereoPanner();
                
                spore.frequency.value = 800 + index * 200;
                sporeGain.gain.value = 0;
                sporePanner.pan.value = (Math.random() - 0.5) * 2;
                
                spore.connect(sporeGain);
                sporeGain.connect(sporePanner);
                sporePanner.connect(this.masterGain);
                
                const now = this.audioContext.currentTime;
                
                // Ascending frequency (escaping boundary layer)
                spore.frequency.exponentialRampToValueAtTime(1600 + index * 400, now + 1);
                
                // Envelope
                sporeGain.gain.setValueAtTime(0, now);
                sporeGain.gain.linearRampToValueAtTime(0.05, now + 0.1);
                sporeGain.gain.exponentialRampToValueAtTime(0.001, now + 1);
                
                spore.start(now);
                spore.stop(now + 1);
            }
            
            setupVisualization() {
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = this.canvas.offsetHeight;
                
                this.animate();
            }
            
            animate() {
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.isPlaying) {
                    // Draw boundary layer
                    const boundaryHeight = this.canvas.height * (0.2 + this.boundaryDepth * 0.3);
                    this.ctx.fillStyle = `rgba(107, 155, 107, ${0.1 + this.moisture * 0.2})`;
                    this.ctx.fillRect(0, this.canvas.height - boundaryHeight, this.canvas.width, boundaryHeight);
                    
                    // Draw moss activity
                    Object.entries(this.mossVoices).forEach(([type, voice], index) => {
                        if (voice && voice.active) {
                            const x = (index + 1) * this.canvas.width / 4;
                            const y = this.canvas.height - boundaryHeight/2;
                            const size = 5 + this.moisture * 10;
                            
                            this.ctx.fillStyle = type === 'rock' ? '#8fbc8f' : 
                                               type === 'log' ? '#9acd32' : '#228b22';
                            this.ctx.beginPath();
                            this.ctx.arc(x, y + Math.sin(Date.now() * 0.001 + index) * 5, size, 0, Math.PI * 2);
                            this.ctx.fill();
                        }
                    });
                    
                    // Draw turbulence
                    if (this.turbulence > 0.5) {
                        for (let i = 0; i < 10; i++) {
                            const x = Math.random() * this.canvas.width;
                            const y = Math.random() * (this.canvas.height - boundaryHeight);
                            this.ctx.fillStyle = `rgba(200, 200, 255, ${this.turbulence * 0.3})`;
                            this.ctx.fillRect(x, y, 2, 2);
                        }
                    }
                }
                
                this.animationId = requestAnimationFrame(() => this.animate());
            }
            
            setupEventListeners() {
                document.getElementById('playBtn').addEventListener('click', async () => {
                    await this.initAudio();
                    this.isPlaying = true;
                    document.getElementById('playBtn').classList.add('active');
                });
                
                document.getElementById('stopBtn').addEventListener('click', () => {
                    this.isPlaying = false;
                    Object.values(this.mossVoices).forEach(voice => {
                        if (voice && voice.active) {
                            voice.envelope.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + 0.5);
                            voice.active = false;
                        }
                    });
                    document.querySelectorAll('.moss-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('playBtn').classList.remove('active');
                });
                
                document.getElementById('volume').addEventListener('input', (e) => {
                    this.volume = parseFloat(e.target.value);
                    this.updateVolume();
                });
                
                document.getElementById('boundaryDepth').addEventListener('input', (e) => {
                    this.boundaryDepth = parseFloat(e.target.value);
                    document.getElementById('layerInfo').textContent = `Boundary Layer: ${this.boundaryDepth}x`;
                    this.updateEnvironment();
                });
                
                document.getElementById('moisture').addEventListener('input', (e) => {
                    this.moisture = parseFloat(e.target.value);
                    this.updateEnvironment();
                });
                
                document.getElementById('turbulence').addEventListener('input', (e) => {
                    this.turbulence = parseFloat(e.target.value);
                    this.updateEnvironment();
                });
                
                document.getElementById('rockMoss').addEventListener('click', () => {
                    this.toggleMoss('rock');
                });
                
                document.getElementById('logMoss').addEventListener('click', () => {
                    this.toggleMoss('log');
                });
                
                document.getElementById('forestMoss').addEventListener('click', () => {
                    this.toggleMoss('forest');
                });
                
                document.getElementById('sporeRelease').addEventListener('click', () => {
                    this.releaseSpores();
                });
            }
        }
        
        // Initialize the sonification
        const sonification = new BoundaryLayerSonification();
    </script>
</body>
</html>
